var events = require('events'),
	util = require('util');

//this will likely come from somewhere else...
var commands = {
	'set':null,
	'get':null,
	'update':null,
	'halt_and_catch_fire':null};

function Dispatcher() {
	if (false === (this instanceof Dispatcher)){
			return new Dispatcher();
	}
	
	events.EventEmitter.call(this);
}

util.inherits(Dispatcher,events.EventEmitter);

Dispatcher.prototype.parseProtocol = function (data){
	var l = +(data.slice(0,4).toString('utf8')),
		m = data.slice(4).toString('utf8'),
		obj = {},
		self = this;
	if (l === m.length){
		obj = JSON.parse(m);
		//self.emit('dispatched',obj);
		
		if (method_dispatcher(obj)){
			self.emit('dispatched',obj);
		}
		else{
			self.emit('error','unknown command');
		}
	}
	else{
		self.emit('error','message garbled');
	}

}

function method_dispatcher(obj){
	if (obj.hasOwnProperty('cmd') && commands.hasOwnProperty(obj.cmd)){
		return true;
	}
	return false;
}

exports.Dispatcher = Dispatcher;

/*
 *
 * first 4 bytes: length of following message
 */ 
